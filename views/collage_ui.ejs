<script>
    const collage_temporal_queries = $("#collageTemporalQueries");
    const collage_canvases = $(".collage-canvas");

    collage_canvases.click(function () {
        collage_canvases.removeClass("paste-active");
        $(this).addClass("paste-active");
    });


    var available_id = 0;
    $(document).on('paste', function (event) {
        const active_canvas = $(".paste-active");

        // use event.originalEvent.clipboard for newer chrome versions
        var items = (event.clipboardData || event.originalEvent.clipboardData).items;

        // find pasted image among pasted items
        var blob = null;
        for (var i = 0; i < items.length; i++) {
            if (items[i].type.indexOf("image") === 0) {
                blob = items[i].getAsFile();
            }
        }

        // load image if there is a pasted image
        if (blob !== null) {
            var reader = new FileReader();
            reader.onload = function (event) {
                const encoded_image = event.target.result;
                const collage_image = collageImageElement("image_" + available_id, encoded_image);
                draggableAndResizable(collage_image, active_canvas);

                active_canvas.append(collage_image);
                available_id++;
            };
            reader.readAsDataURL(blob);
        }

    });

    function draggableAndResizable(elements, containment) {
        elements.draggable({
            containment: containment
        });

        elements.resizable({
            containment: containment,
            aspectRatio: true,
        });
    }

    function deleteElementByUid(uid) {
        var elem = document.getElementById(uid);
        elem.remove();
    }

    function collageImageElement(uid, src) {
        return $(
            `<div id="${uid}" class="collage-image ui-widget-content">
                <span class="delete" onclick="deleteElementByUid($(this).closest('div').attr('id'))">&times;</span>
                <img src="${src}">
            </div>`
        );
    }

    function collectCollage(idx) {
        return collectCollageImages($(collage_canvases[idx]))
    }

    function collectCollageImages(collage_canvas) {
        const images = collage_canvas.find(".collage-image");

        let images_information = [];
        for (var i = 0; i < images.length; i++) {
            const image = images.eq(i);
            images_information.push({
                src: image.children("img").attr("src"),
                top: image.position().top / collage_canvas.height(),
                left: image.position().left / collage_canvas.width(),
                width: image.width() / collage_canvas.width(),
                height: image.height() / collage_canvas.height()
            });
        }

        return images_information;
    }


</script>